<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Checklist</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; padding: 15px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Scanner Styling */
        #reader { width: 100%; border-radius: 8px; margin-bottom: 20px; background: #eee; }
        .btn-open { width: 100%; background: #007bff; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; margin-bottom: 20px; cursor: pointer; }

        /* Table Styling */
        .table-wrap { overflow-x: auto; margin-top: 20px; max-height: 500px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #007bff; color: white; position: sticky; top: 0; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }

        /* Status Effects */
        .checked-in { background-color: #e9ecef !important; color: #adb5bd; }
        .checked-in td:nth-child(2) { text-decoration: line-through; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #dc3545; margin-right: 5px; }
        .checked-in .status-dot { background: #28a745; }
    </style>
</head>
<body>

<div class="container">
    <h2>Attendance Checklist</h2>
    
    <button class="btn-open" id="start-btn" onclick="startScanner()">Click to Scan QR</button>
    <div id="reader"></div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Participant Name</th>
                    <th>Organization</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
    let participants = [];

    // 1. Fetch JSON and Build Table immediately
    fetch('participants_2.json')
        .then(res => res.json())
        .then(data => {
            participants = data;
            const tbody = document.getElementById('table-body');
            
            data.forEach(p => {
                const row = document.createElement('tr');
                row.id = "row-" + p.ID; // Unique ID for each row
                row.innerHTML = `
                    <td>${p.ID}</td>
                    <td><strong>${p.Name}</strong> ${p[""] || ""}</td>
                    <td>${p["__1"] || "---"}</td>
                    <td><span class="status-dot"></span><span class="status-text">Waiting</span></td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => alert("Error: JSON file not found in this repository!"));

    // 2. Scan Logic
    function onScanSuccess(decodedText) {
        const scanResult = decodedText.trim();

        // Find match based on the "Whole Name" format you confirmed
        const person = participants.find(p => p["Combined (A+B+C)"].trim() === scanResult);

        if (person) {
            const row = document.getElementById("row-" + person.ID);
            if (row && !row.classList.contains('checked-in')) {
                // Apply Grey-out
                row.classList.add('checked-in');
                row.querySelector('.status-text').innerText = "Checked In";
                
                // Audio/Vibration feedback
                if (navigator.vibrate) navigator.vibrate(100);
                alert("Welcome, " + person.Name + " (" + person["__1"] + ")");
            }
        } else {
            alert("No match found for:\n" + scanResult);
        }
    }

    // 3. Initialize Scanner
    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess);
    }
</script>

</body>
</html>
